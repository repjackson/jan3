template(name='incident_view')
    .ui.padded.stackable.centered.grid
        .centered.middle.aligned.row
            .three.wide.center.aligned.column
                if is_customer
                    +link_button link='/p/customer_incidents' icon='error' label='My Incidents'
                if is_office
                    +link_button link=my_office_link icon='error' label='Office Incidents'
                    // a.ui.button(href="/office/#{my_office._id}/incidents")
                    //     +icon name='error'
                    //     | Office Incidents    
                if is_admin
                    +link_button link='/p/admin_incidents' icon='user-shield' label='All Incidents'
            .nine.wide.column
                h1.ui.center.aligned.header 
                    |##{incident_number} #{customer_name} Incident 
                    unless is_customer
                        +level_icon
            .four.wide.column
                if is_dev
                    .ui.icon.remove_incident.button(data-content='Delete Incident')
                        i.remove.icon
                if currentUser
                    unless is_customer
                        #run_single_escalation_check.ui.button 
                            i.user.shield.icon
                            |Check Escalation
        .row
            .three.wide.column
                // if is_dev
                //     +edit_author
                    // +edit_number_field key='incident_number' label='Number' icon='hashtag'
                // h4.ui.header Incident #
                //     if incident_number
                //         |#{incident_number}
                //     else
                //         +call_method name='update_incident_number' argument=_id                
                unless can_edit_core
                    .ui.secondary.segment
                        .ui.header 
                            +icon name='leave'
                            |Date
                        h4 #{service_date}
                unless is_customer
                    +customer_card customer_jpid=customer_jpid
                    +franchisee_card franchisee_jpid=franchisee_jpid
                    +office_card office_jpid=office_jpid
                    +user_card
                if submitted
                    .ui.secondary.segment
                        .ui.header Type
                        +incident_type_label
                unless is_customer
                    .ui.secondary.segment
                        .ui.header Last Updated
                        |{{ long_format updated }}

            .nine.wide.column
                unless open
                    if feedback_doc
                        with feedback_doc
                            .ui.secondary.segment
                                .ui.header 
                                    +icon name='feedback'
                                    |Feedback
                                if positive
                                    i.green.thumbs.up.icon
                                else
                                    i.red.thumbs.down.icon
                                |#{text}
                    else
                        #submit_feedback.ui.button Submit Feedback
                if can_edit_core
                    .ui.header 
                        +icon name='category'
                        |Type
                    each incident_type_docs
                        +toggle_key key='incident_type' value=slug label=name
                    +edit_textarea label='Details' key='incident_details' icon='view-details'
                    // +edit_datetime_field key='service_date' label='Service Time' icon='leave'
                    +edit_datetime_field key='service_date' label='Service Time'
                else
                    .ui.basic.segment
                        // +icon name='view-details'
                        .large130 #{incident_details}
                unless can_edit_core
                    +comments
                    +full_doc_history
                if can_edit_core
                    +edit_image_field
                else
                    if image_id
                        img.ui.centered.image(src="{{c.url image_id height=500 crop='fit'}}")
            .four.wide.column
                if submitted
                    .ui.secondary.segment
                        .ui.header 
                            +status_template
                            if open
                                |Open
                            else
                                |Closed
                        unless is_customer
                            if open
                                .close_incident.ui.fluid.button
                                    i.calendar.times.icon
                                    | Close Incident
                            else
                                // .reopen_incident.ui.fluid.button
                                //     i.user.shield.icon
                                //     | Reopen Incident
                                .ui.button 
                                    i.reply.icon
                                    |Create Related Ticket
                if submitted
                    .ui.secondary.segment
                        .ui.header
                            +icon name='internal'
                            | Submitted 
                        |{{long_format submitted_datetime}}
                    // unless is_customer
                    //     .unsubmit.ui.fluid.button
                    //         i.user.shield.icon
                    //         |Unsubmit
                if can_submit
                    .submit.ui.fluid.large.button
                        i.green.checkmark.icon
                        |Submit
                else
                    if is_customer
                        unless submitted
                            .ui.secondary.segment Fill Date, Details, and Type to Submit
                unless is_customer
                    +assignment_widget
                // +incident_sla_widget



template(name='level_icon')
    if is_level_one
        img.ui.mini.image(src="/level1icon.png" data-content='Level 1')
    if is_level_two
        img.ui.mini.image(src="/level2icon.png" data-content='Level 2')
    if is_level_three
        img.ui.mini.image(src="/level3icon.png" data-content='Level 3')
    if is_level_four
        img.ui.mini.image(src="/level4icon.png" data-content='Level 4')
                        
template(name='incident_type_label')    
    if incident_type_label
        +icon name=incident_type_icon popup=incident_type_label
        // .ui.label(class=type_label_class) #{incident_type_label}



template(name='add_incident_button')
    if has_user_customer_jpid
        a.ui.button#add_incident(href='#' data-content='Create New Incident')
            i.large.green.plus.icon
            |Log New Incident
    else
        if is_customer
            .ui.secondary.segment Add Office to Profile to Add Incident


template(name='incident_sla_widget')
    .ui.secondary.segment
        .ui.header 
            i.user.shield.icon
            |SLA Rules List for #{incident_doc.incident_type}
        each sla_rule_docs
            +sla_rule_doc
            
template(name='sla_rule_doc')            
    .ui.dividing.header 
        // if is_level
        //     i.green.checkmark.icon(data-content="Current Level: #{incident_doc.level}")
        unless is_level
            .set_level.ui.small.compact.button(data-content="Simulate Escalation to #{number}.") Set Level #{number}
        |#{name}
    .content
        unless is_initial
            strong Hours: #{hours_value}
        if franchisee_toggle_value
            .item Franchisee
    .content
        | Primary Contact
        strong #{primary_contact_value} 
    .content
        | Secondary Contact
        strong #{secondary_contact_value} 
            //     .ui.disabled.button Can't Set #{number}
            